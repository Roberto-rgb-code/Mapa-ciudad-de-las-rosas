<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa - Guadalajara Ciudad de las Rosas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        .info-window {
            max-width: 380px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            overflow: hidden;
        }

        .info-window-header {
            position: relative;
            background: linear-gradient(135deg, #8B1538 0%, #C41E3A 100%);
            padding: 16px;
            color: white;
        }

        .info-window-header.historical {
            background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
        }

        .info-window-header.business {
            background: linear-gradient(135deg, #E65100 0%, #F57C00 100%);
        }

        .info-window-image {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            background: rgba(255,255,255,0.95);
            padding: 6px;
            float: right;
            margin-left: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .info-window h3 {
            color: white;
            margin: 0 0 8px 0;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.3;
        }

        .info-window .category {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-window-body {
            padding: 16px;
            background: #fff;
        }

        .info-window p {
            color: #444;
            font-size: 13px;
            line-height: 1.6;
            margin: 0 0 12px 0;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .info-window .address {
            color: #555;
            font-size: 13px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #8B1538;
        }

        .info-window .address.historical {
            border-left-color: #1565C0;
        }

        .info-window .address.business {
            border-left-color: #E65100;
        }

        .info-window-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .info-window .contact-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #555;
            font-size: 12px;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .info-window .contact-item:hover {
            background: #8B1538;
            color: white;
            border-color: #8B1538;
        }

        .info-window .contact-item svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .info-window strong {
            color: #8B1538;
        }

        .geolocation-button {
            position: absolute;
            bottom: 140px;
            right: 20px;
            z-index: 1000;
            background: white;
            color: #333;
            border: none;
            padding: 0;
            border-radius: 2px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .geolocation-button:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .geolocation-button:active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .geolocation-message {
            position: absolute;
            bottom: 190px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            max-width: 250px;
            display: none;
        }

        .geolocation-message.error {
            background: rgba(244, 67, 54, 0.95);
            color: white;
        }

        .geolocation-message.success {
            background: rgba(76, 175, 80, 0.95);
            color: white;
        }

        .geolocation-instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 320px;
            display: none;
        }

        .geolocation-instructions h4 {
            margin: 0 0 10px 0;
            color: #8B1538;
            font-size: 15px;
        }

        .geolocation-instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .geolocation-instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .geolocation-instructions .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 1;
        }

        .geolocation-instructions .close-btn:hover {
            color: #333;
        }

        .layers-button {
            position: absolute;
            top: 120px;
            right: 20px;
            z-index: 1000;
            background: white;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 2px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layers-button:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .layers-button:active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .layers-menu {
            position: absolute;
            top: 170px;
            right: 20px;
            z-index: 1001;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 200px;
            display: none;
            overflow: hidden;
        }

        .layers-menu.active {
            display: block;
        }

        .layers-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .layers-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f5f5f5;
        }

        .layers-menu-item:last-child {
            border-bottom: none;
        }

        .layers-menu-item:hover {
            background-color: #f5f5f5;
        }

        .layers-menu-item.active {
            background-color: #e3f2fd;
        }

        .layers-menu-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layers-menu-item-label {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .layers-menu-item-check {
            width: 20px;
            height: 20px;
            color: #1976d2;
            display: none;
        }

        .layers-menu-item.active .layers-menu-item-check {
            display: block;
        }

        .map-type-button {
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 1000;
            background: white;
            color: #333;
            border: none;
            padding: 8px;
            border-radius: 2px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-type-button:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .map-type-button:active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .map-type-menu {
            position: absolute;
            top: 120px;
            right: 20px;
            z-index: 1001;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 200px;
            display: none;
            overflow: hidden;
        }

        .map-type-menu.active {
            display: block;
        }

        .map-type-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .map-type-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f5f5f5;
        }

        .map-type-menu-item:last-child {
            border-bottom: none;
        }

        .map-type-menu-item:hover {
            background-color: #f5f5f5;
        }

        .map-type-menu-item.active {
            background-color: #e3f2fd;
        }

        .map-type-menu-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-type-menu-item-label {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .map-type-menu-item-check {
            width: 20px;
            height: 20px;
            color: #1976d2;
            display: none;
        }

        .map-type-menu-item.active .map-type-menu-item-check {
            display: block;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="btnLayers" class="layers-button" title="Capas del mapa">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
    </button>
    <div id="layersMenu" class="layers-menu">
        <div class="layers-menu-header">Capas del mapa</div>
        <div class="layers-menu-item" data-layer="traffic">
            <div class="layers-menu-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 10h-3V8.86c1.72-.45 3-2 3-3.86h-3V4c0-.55-.45-1-1-1H8c-.55 0-1 .45-1 1v1H4c0 1.86 1.28 3.41 3 3.86V10H4c0 1.86 1.28 3.41 3 3.86V15H4v2h3v1.14c1.72.45 3 2 3 3.86h3V22c0 .55.45 1 1 1h8c.55 0 1-.45 1-1v-1h3c0-1.86-1.28-3.41-3-3.86V15h3v-2h-3v-1.14c-1.72-.45-3-2-3-3.86zm-8 9c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" fill="#666"/>
                    <path d="M12 15c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" fill="#666"/>
                </svg>
            </div>
            <div class="layers-menu-item-label">Tr√°fico</div>
            <svg class="layers-menu-item-check" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
        </div>
        <div class="layers-menu-item" data-layer="transit">
            <div class="layers-menu-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 001 1h1a1 1 0 001-1v-1h8v1a1 1 0 001 1h1a1 1 0 001-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z" fill="#666"/>
                </svg>
            </div>
            <div class="layers-menu-item-label">Transporte p√∫blico</div>
            <svg class="layers-menu-item-check" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
        </div>
    </div>
    <button id="btnMapType" class="map-type-button" title="Tipo de mapa">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="7" height="7" fill="#666" rx="1"/>
            <rect x="13" y="6" width="7" height="7" fill="none" stroke="#666" stroke-width="1.5" rx="1"/>
        </svg>
    </button>
    <div id="mapTypeMenu" class="map-type-menu">
        <div class="map-type-menu-header">Tipo de mapa</div>
        <div class="map-type-menu-item" data-map-type="roadmap">
            <div class="map-type-menu-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
            </div>
            <div class="map-type-menu-item-label">Est√°ndar</div>
            <svg class="map-type-menu-item-check" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
        </div>
        <div class="map-type-menu-item" data-map-type="satellite">
            <div class="map-type-menu-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V5h14v14H5z" fill="#666"/>
                    <path d="M7 7h10v10H7z" fill="#666"/>
                </svg>
            </div>
            <div class="map-type-menu-item-label">Sat√©lite</div>
            <svg class="map-type-menu-item-check" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
        </div>
        <div class="map-type-menu-item" data-map-type="terrain">
            <div class="map-type-menu-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" fill="#666"/>
                </svg>
            </div>
            <div class="map-type-menu-item-label">Relieve</div>
            <svg class="map-type-menu-item-check" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
        </div>
    </div>
    <button id="btnGeolocation" class="geolocation-button" title="Mostrar mi ubicaci√≥n exacta">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM20.94 11C20.48 6.83 17.17 3.52 13 3.06V1H11V3.06C6.83 3.52 3.52 6.83 3.06 11H1V13H3.06C3.52 17.17 6.83 20.48 11 20.94V23H13V20.94C17.17 20.48 20.48 17.17 20.94 13H23V11H20.94ZM12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19Z" fill="#333"/>
        </svg>
    </button>
    <div id="geolocationMessage" class="geolocation-message"></div>
    <div id="geolocationInstructions" class="geolocation-instructions">
        <button class="close-btn" onclick="document.getElementById('geolocationInstructions').style.display='none'">√ó</button>
        <h4>üìç Para ubicaci√≥n exacta</h4>
        <ol>
            <li>Haz clic en el √≠cono de <strong>candado</strong> o <strong>informaci√≥n</strong> junto a la URL</li>
            <li>Busca <strong>"Ubicaci√≥n"</strong> o <strong>"Location"</strong></li>
            <li>Cambia de <strong>"Bloquear"</strong> a <strong>"Permitir"</strong></li>
            <li>Recarga la p√°gina o haz clic en el bot√≥n de ubicaci√≥n</li>
        </ol>
        <p style="margin-top: 10px; font-size: 11px; color: #666;">
            <strong>Nota:</strong> Sin permisos solo se muestra ubicaci√≥n aproximada por IP (precisi√≥n ~2km)
        </p>
    </div>

    <script>
        // Coordenadas de los lugares
        const lugares = {
            historicos: [
                {
                    nombre: "Santuario de Nuestra Se√±ora de Guadalupe",
                    lat: 20.68482,
                    lng: -103.34825,
                    categoria: "EDIFICIO HIST√ìRICO",
                    descripcion: "La primera piedra se coloc√≥ el 7 de enero de 1777 y tras cuatro a√±os de obras, la iglesia se inaugur√≥ en 1781. La construcci√≥n fue promovida y costeada por el fil√°ntropo espa√±ol y entonces obispo de la di√≥cesis, Antonio Alcalde y Barriga, quien tuvo la idea de edificar una iglesia en la parte norte de la ciudad de Guadalajara, que en aquel entonces estaba pr√°cticamente deshabitada. Fue el mismo obispo Alcalde quien coste√≥ los gastos de la construcci√≥n del templo, as√≠ como la construcci√≥n de varias casas que se rentar√≠an a bajo precio para las personas pobres que quisieran habitarlas, llamadas \"las cuadritas\" del Barrio del Santuario. La imagen de Nuestra Se√±ora de Guadalupe se encuentra en el altar principal, pintura que data de 1779 realizada por Don Jos√© de Alc√≠bar.",
                    direccion: "Barrio del Santuario, Guadalajara, Jal.",
                    imagen: "assets/santuario.png"
                },
                {
                    nombre: "Catedral de Guadalajara",
                    lat: 20.67672,
                    lng: -103.34764,
                    categoria: "EDIFICIO HIST√ìRICO",
                    descripcion: "Oficialmente Catedral Bas√≠lica de la Asunci√≥n de Mar√≠a Sant√≠sima, es la sede de la arquidi√≥cesis de Guadalajara y uno de los principales templos de la Iglesia cat√≥lica en M√©xico. Entre las criptas, debajo de lo que fue la capilla real, se encuentra la de los arzobispos de Guadalajara que datan del siglo XVI. Destacan los dedicados a La Virgen de las Rosas, Santiago el Mayor (patrono de la Nueva Espa√±a), La Virgen de Guadalupe, Nuestra Se√±ora de Zapopan entre otros.",
                    direccion: "Av. Fray Antonio Alcalde, Zona Centro, Guadalajara, Jal.",
                    imagen: "assets/catedral_new.png"
                },
                {
                    nombre: "Rotonda de los Jaliscienses Ilustres",
                    lat: 20.67777,
                    lng: -103.34701,
                    categoria: "EDIFICIO HIST√ìRICO",
                    descripcion: "Rinde homenaje a los jaliscienses que han trascendido a trav√©s de la historia. El monumento construido en 1952, por el arquitecto Vicente Mendiola, bajo iniciativa del entonces gobernador Jos√© de Jes√∫s Gonz√°lez Gallo, consta de diecisiete columnas estriadas sin base ni capitel y que sostienen un anillo de cantera que tiene grabado en uno de sus lados la leyenda \"Jalisco a sus hijos esclarecidos\"; en el centro del monumento existe un pebetero, adem√°s de 98 nichos para albergar los cuerpos de los hombres y mujeres m√°s ilustres nacidos en Jalisco.",
                    direccion: "Av. Fray Antonio Alcalde, Zona Centro, Guadalajara, Jal.",
                    imagen: "assets/rotonda.png"
                },
                {
                    nombre: "Mercado San Juan de Dios",
                    lat: 20.675562,
                    lng: -103.33986,
                    categoria: "EDIFICIO HIST√ìRICO",
                    descripcion: "Es el mercado techado m√°s grande de Am√©rica Latina. Obra del arquitecto Alejandro Zohn, se inaugur√≥ el 30 de diciembre de 1958. Se encuentra ubicado en lo que una vez fue la orilla oriental del r√≠o San Juan de Dios, cercano a la capital de la entonces Nueva Galicia. La zona era la entrada de los abastecimientos provenientes de la Ciudad de M√©xico. Hacia 1880, Mariano B√°rcena da cuenta de la existencia del mercado como uno de los tres principales de Guadalajara, junto al de la plaza de Venegas o de la Independencia (actual mercado Corona) y el de plaza de Toros o plaza Alcalde. Para esas fechas y hasta principios del siglo xx, el mercado pose√≠a la estructura del tianguis mexicano: tablados, lonas, mesas y tendidos sobre el suelo, todo esto al aire libre.",
                    direccion: "Calle Javier Mina, Zona Centro, Guadalajara, Jal.",
                    imagen: "assets/mercadosanjuandedios.png"
                }
            ],
            empresas: [
                {
                    nombre: "Restaurante Casa Dolores",
                    lat: 20.67750,
                    lng: -103.34650,
                    categoria: "RESTAURANTE",
                    descripcion: "COMIDA MEXICANA - Inspirada en el aroma de la historia de M√©xico. Somos un restaurante que elogia lo mejor de M√©xico, trasformando sus tradicionales sabores, texturas y aromas en los m√°s exquisitos platillos de cocina mexicana, resultado de una cuidadosa selecci√≥n de ingredientes, teniendo muy presente nuestro legado que implica ser orgullosamente mexicanos.",
                    direccion: "Paseo Alcalde 22, Col. Centro. Guadalajara, Jal.",
                    horario: "Lunes ‚Äì Domingo: 8:00 am ‚Äì 10:00 pm",
                    telefono: "+52 33 1001 8581",
                    web: "opentable.com.mx",
                    instagram: "@casadoloresgdl"
                },
                {
                    nombre: "Ex Convento de Santa Teresa",
                    lat: 20.67800,
                    lng: -103.34800,
                    categoria: "SAL√ìN DE EVENTOS",
                    descripcion: "Donde cada rinc√≥n, es un bello espacio hist√≥rico que har√° resaltar tu evento. Recinto con 400 a√±os de historia que forma parte de la riqueza arquitect√≥nica de la ciudad, para hacer de tu evento la vivencia m√°s memorable y exclusiva. Fundado en el siglo XVII, por la orden de las carmelitas descalzas como el primer claustro en Guadalajara. \"Nuestra historia es el marco ideal para tus nuevas historias\"",
                    direccion: "Donato Guerra 25, Zona Centro, 44100 Guadalajara, Jal.",
                    telefono: "+52 33 1989 0373",
                    web: "exconvento.com.mx",
                    facebook: "facebook.com/ExconventoST",
                    instagram: "@exconventost"
                },
                {
                    nombre: "Casa Anguiano",
                    lat: 20.67720,
                    lng: -103.34780,
                    categoria: "ART√çCULOS RELIGIOSOS",
                    descripcion: "Casa fundada en 1942. L√≠deres en la comercializaci√≥n de Art√≠culos Religiosos en la Rep√∫blica Mexicana. Nuestra empresa cuenta con un punto de venta al p√∫blico en el centro de la bella ciudad de Guadalajara, a unas cuantas calles de nuestra emblem√°tica Catedral, ademas de un taller propio donde fabricamos diferentes art√≠culos y proporcionamos varios servicios como restauraciones de imagenes y metales sagrados por mencionar algunos.",
                    direccion: "Av. Fray Antonio Alcalde 113, Col. Centro. Guadalajara, Jal.",
                    horario: "Lunes ‚Äì Domingo: 8:00 am ‚Äì 10:00 pm",
                    telefono: "+52 333 614 6880",
                    whatsapp: "+52 331 061 6961",
                    web: "casaanguiano.com"
                },
                {
                    nombre: "El Pil√≥n de los Arrieros",
                    lat: 20.67600,
                    lng: -103.34550,
                    categoria: "GASTRONOM√çA ARTESANAL",
                    descripcion: "Con m√°s de 40 a√±os de tradici√≥n. Lupita Figueroa es la due√±a de todas las recetas, donde se sirven excelentes platillos, teniendo como especialidad la birria de chivo, adem√°s de la barbacoa de borrego, exquisitos chamorros adobados y la cochinita pibil complementan sus deliciosos platillos. Ven y disfruta de un fest√≠n de sabores mexicanos. Por sus mesas han pasado artistas, cantantes, actores, personajes de la radio y la televisi√≥n nacionales y extranjeros.",
                    direccion: "Calle Galeana 388, Plaza de las 9 esquinas, Centro Hist√≥rico. Guadalajara, Jal.",
                    horario: "Lunes ‚Äì Domingo: 9:00 am ‚Äì 9:00 pm",
                    telefono: "+52 33 3613 2799",
                    instagram: "@elpilondelosarrieros"
                }
            ]
        };

        // Funci√≥n para inicializar el mapa
        function initMap() {
            // Calcular el centro √≥ptimo basado en todos los puntos
            const todosLosPuntos = [...lugares.historicos, ...lugares.empresas];
            const sumaLat = todosLosPuntos.reduce((acc, p) => acc + p.lat, 0);
            const sumaLng = todosLosPuntos.reduce((acc, p) => acc + p.lng, 0);
            const centro = { 
                lat: sumaLat / todosLosPuntos.length, 
                lng: sumaLng / todosLosPuntos.length 
            };
            
            // Crear el mapa centrado donde est√°n los puntos
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15, // Zoom para mostrar todos los puntos claramente
                center: centro,
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Variables para controlar las capas
            let trafficLayer = null;
            let transitLayer = null;
            const layerStates = {
                traffic: false,
                transit: false
            };

            // Inicializar capas de Google Maps
            trafficLayer = new google.maps.TrafficLayer();
            transitLayer = new google.maps.TransitLayer();

            // Widget de Capas (Tr√°fico y Transporte p√∫blico)
            const layersButton = document.getElementById('btnLayers');
            const layersMenu = document.getElementById('layersMenu');
            const layerItems = layersMenu.querySelectorAll('.layers-menu-item');

            // Widget de Tipo de Mapa (Est√°ndar, Sat√©lite, Relieve)
            const mapTypeButton = document.getElementById('btnMapType');
            const mapTypeMenu = document.getElementById('mapTypeMenu');
            const mapTypeItems = mapTypeMenu.querySelectorAll('.map-type-menu-item');

            // Toggle del men√∫ de capas
            layersButton.addEventListener('click', function(e) {
                e.stopPropagation();
                layersMenu.classList.toggle('active');
                // Cerrar el men√∫ de tipo de mapa si est√° abierto
                mapTypeMenu.classList.remove('active');
            });

            // Manejar clics en los items del men√∫ de capas
            layerItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const layerType = this.getAttribute('data-layer');
                    toggleLayer(layerType);
                });
            });

            // Funci√≥n para activar/desactivar capas
            function toggleLayer(layerType) {
                const item = layersMenu.querySelector(`[data-layer="${layerType}"]`);
                
                if (layerType === 'traffic') {
                    layerStates.traffic = !layerStates.traffic;
                    if (layerStates.traffic) {
                        trafficLayer.setMap(map);
                        item.classList.add('active');
                    } else {
                        trafficLayer.setMap(null);
                        item.classList.remove('active');
                    }
                } else if (layerType === 'transit') {
                    layerStates.transit = !layerStates.transit;
                    if (layerStates.transit) {
                        transitLayer.setMap(map);
                        item.classList.add('active');
                    } else {
                        transitLayer.setMap(null);
                        item.classList.remove('active');
                    }
                }
            }

            // Marcar "Est√°ndar" como activo por defecto
            const defaultMapTypeItem = mapTypeMenu.querySelector('[data-map-type="roadmap"]');
            if (defaultMapTypeItem) {
                defaultMapTypeItem.classList.add('active');
            }

            // Toggle del men√∫ de tipo de mapa
            mapTypeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                mapTypeMenu.classList.toggle('active');
                // Cerrar el men√∫ de capas si est√° abierto
                layersMenu.classList.remove('active');
            });

            // Manejar clics en los items del men√∫ de tipo de mapa
            mapTypeItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const mapType = this.getAttribute('data-map-type');
                    setMapType(mapType);
                });
            });

            // Funci√≥n para cambiar el tipo de mapa base
            function setMapType(mapType) {
                // Remover activo de todos los items
                mapTypeItems.forEach(item => {
                    item.classList.remove('active');
                });

                // Activar el item seleccionado
                const selectedItem = mapTypeMenu.querySelector(`[data-map-type="${mapType}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }

                // Cambiar el tipo de mapa
                map.setMapTypeId(mapType);
            }

            // Cerrar los men√∫s al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!layersMenu.contains(e.target) && !layersButton.contains(e.target)) {
                    layersMenu.classList.remove('active');
                }
                if (!mapTypeMenu.contains(e.target) && !mapTypeButton.contains(e.target)) {
                    mapTypeMenu.classList.remove('active');
                }
            });

            // Funci√≥n para crear icono personalizado desde imagen
            function crearIconoPersonalizado(rutaImagen, tama√±o = 60) {
                return {
                    url: rutaImagen,
                    scaledSize: new google.maps.Size(tama√±o, tama√±o),
                    anchor: new google.maps.Point(tama√±o / 2, tama√±o),
                    origin: new google.maps.Point(0, 0)
                };
            }

            // Icono de georreferenciaci√≥n para empresas sin imagen
            const iconoGeorreferenciacion = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 2 C14.06 2 6 10.06 6 20 C6 29.94 24 46 24 46 C24 46 42 29.94 42 20 C42 10.06 33.94 2 24 2 Z" 
                              fill="#8B1538" stroke="#fff" stroke-width="2"/>
                        <circle cx="24" cy="20" r="6" fill="#fff"/>
                        <circle cx="24" cy="20" r="3" fill="#8B1538"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(48, 48),
                anchor: new google.maps.Point(24, 48)
            };

            // Icono para la ubicaci√≥n actual del usuario (persona/usuario)
            const iconoUbicacionUsuario = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20" fill="#4285F4" stroke="#fff" stroke-width="3"/>
                        <circle cx="24" cy="18" r="7" fill="#fff"/>
                        <path d="M12 38 C12 32 16 28 24 28 C32 28 36 32 36 38" fill="#fff"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(48, 48),
                anchor: new google.maps.Point(24, 48)
            };

            // Funci√≥n para crear contenido del info window mejorado
            function crearContenidoInfo(lugar) {
                const esHistorico = lugar.categoria.includes('HIST√ìRICO');
                const categoriaClass = esHistorico ? 'historical' : 'business';
                
                // Imagen del lugar (si existe)
                const imagenHTML = lugar.imagen 
                    ? `<img src="${lugar.imagen}" alt="${lugar.nombre}" class="info-window-image">` 
                    : '';
                
                let contenido = `
                    <div class="info-window">
                        <div class="info-window-header ${categoriaClass}">
                            ${imagenHTML}
                            <span class="category">${lugar.categoria}</span>
                            <h3>${lugar.nombre}</h3>
                        </div>
                        <div class="info-window-body">
                            <p>${lugar.descripcion}</p>
                            <div class="address ${categoriaClass}">
                                <strong>üìç Direcci√≥n</strong><br>${lugar.direccion}
                            </div>
                        </div>
                `;

                // Agregar footer con contactos si existen
                const tieneContacto = lugar.horario || lugar.telefono || lugar.whatsapp || lugar.web || lugar.instagram || lugar.facebook;
                
                if (tieneContacto) {
                    contenido += `<div class="info-window-footer">`;
                    
                    if (lugar.horario) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
                            ${lugar.horario}
                        </span>`;
                    }

                    if (lugar.telefono) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                            ${lugar.telefono}
                        </span>`;
                    }

                    if (lugar.whatsapp) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            WhatsApp
                        </span>`;
                    }

                    if (lugar.web) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            Web
                        </span>`;
                    }

                    if (lugar.instagram) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                            Instagram
                        </span>`;
                    }

                    if (lugar.facebook) {
                        contenido += `<span class="contact-item">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            Facebook
                        </span>`;
                    }

                    contenido += `</div>`;
                }

                contenido += `</div>`;
                return contenido;
            }

            // Agregar marcadores hist√≥ricos con im√°genes personalizadas
            lugares.historicos.forEach(lugar => {
                const icono = lugar.imagen 
                    ? crearIconoPersonalizado(lugar.imagen, 60)
                    : iconoEmpresa;

                const marker = new google.maps.Marker({
                    position: { lat: lugar.lat, lng: lugar.lng },
                    map: map,
                    title: lugar.nombre,
                    icon: icono
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: crearContenidoInfo(lugar)
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });

            // Agregar marcadores de empresas
            lugares.empresas.forEach(lugar => {
                const marker = new google.maps.Marker({
                    position: { lat: lugar.lat, lng: lugar.lng },
                    map: map,
                    title: lugar.nombre,
                    icon: iconoGeorreferenciacion
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: crearContenidoInfo(lugar)
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });

            // Variables para almacenar el marcador y c√≠rculo del usuario
            let userMarker = null;
            let accuracyCircle = null;

            // Funci√≥n para mostrar mensaje
            function mostrarMensaje(mensaje, tipo = 'info') {
                const messageDiv = document.getElementById('geolocationMessage');
                if (messageDiv) {
                    messageDiv.textContent = mensaje;
                    messageDiv.className = 'geolocation-message ' + tipo;
                    messageDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
            }

            // Funci√≥n para obtener ubicaci√≥n usando Google Geolocation API
            // Nota: Desde navegadores web, solo puede usar IP (precisi√≥n similar a geolocalizaci√≥n por IP)
            // Para mayor precisi√≥n, se necesitan permisos de geolocalizaci√≥n del navegador (GPS)
            async function obtenerUbicacionGoogleGeolocation() {
                try {
                    // Google Geolocation API puede usar informaci√≥n de red (WiFi, torres celulares)
                    // pero desde navegadores web no tenemos acceso a esa informaci√≥n por seguridad
                    // Por lo tanto, solo usar√° la IP, dando precisi√≥n similar a geolocalizaci√≥n por IP
                    const requestBody = {
                        considerIp: true // Usar IP (√∫nica opci√≥n disponible desde navegador web)
                    };
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);
                    
                    const response = await fetch(
                        `https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCFGebMe1CODtGrn8fXU9oAa7-I6DgaBhM`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        }
                    );
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`HTTP ${response.status}: ${errorData.error?.message || 'Error desconocido'}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.location && data.location.lat && data.location.lng) {
                        const accuracy = data.accuracy || 5000; // Precisi√≥n en metros (t√≠picamente 1-5km con IP)
                        console.log('‚úÖ Ubicaci√≥n obtenida por Google Geolocation API - Precisi√≥n:', Math.round(accuracy), 'metros');
                        
                        // Si la precisi√≥n es muy baja (>5km), es b√°sicamente geolocalizaci√≥n por IP
                        if (accuracy > 5000) {
                            console.log('‚ö†Ô∏è Precisi√≥n baja: usando principalmente IP. Para ubicaci√≥n exacta, permite permisos de geolocalizaci√≥n.');
                        }
                        
                        return {
                            lat: data.location.lat,
                            lng: data.location.lng,
                            accuracy: accuracy,
                            source: 'google-geolocation'
                        };
                    }
                    
                    throw new Error('Datos inv√°lidos de Google Geolocation API');
                } catch (error) {
                    console.log('‚ö†Ô∏è Google Geolocation API fall√≥:', error.message);
                    return null;
                }
            }

            // Funci√≥n para obtener ubicaci√≥n por IP (respaldo si Google Geolocation falla)
            async function obtenerUbicacionPorIP() {
                const servicios = [
                    // Servicio 1: ip-api.com (HTTP, no HTTPS en versi√≥n gratuita)
                    async () => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        try {
                            // Intentar HTTP primero (seg√∫n documentaci√≥n)
                            let response;
                            try {
                                response = await fetch('http://ip-api.com/json/?fields=status,message,lat,lon,city,regionName,country', {
                                    signal: controller.signal,
                                    headers: {
                                        'Accept': 'application/json',
                                    },
                                });
                            } catch (mixedContentError) {
                                // Si hay error de mixed content (HTTPS bloqueando HTTP), intentar con HTTPS
                                // aunque la documentaci√≥n dice que no est√° disponible, algunos casos funcionan
                                console.log('‚ö†Ô∏è HTTP bloqueado, intentando HTTPS...');
                                response = await fetch('https://ip-api.com/json/?fields=status,message,lat,lon,city,regionName,country', {
                                    signal: controller.signal,
                                    headers: {
                                        'Accept': 'application/json',
                                    },
                                });
                            }
                            
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.status === 'success' && data.lat && data.lon) {
                                return {
                                    lat: parseFloat(data.lat),
                                    lng: parseFloat(data.lon),
                                    accuracy: 2000,
                                    city: data.city,
                                    region: data.regionName,
                                    source: 'ip-api.com'
                                };
                            }
                            throw new Error('Datos inv√°lidos');
                        } catch (error) {
                            clearTimeout(timeoutId);
                            throw error;
                        }
                    },
                    // Servicio 2: ipapi.co (respaldo)
                    async () => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch('https://ipapi.co/json/', {
                            signal: controller.signal,
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.latitude && data.longitude && !data.error) {
                            return {
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                accuracy: 2000,
                                city: data.city,
                                region: data.region,
                                source: 'ipapi.co'
                            };
                        }
                        throw new Error('Datos inv√°lidos');
                    },
                    // Servicio 3: ipinfo.io (respaldo)
                    async () => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch('https://ipinfo.io/json', {
                            signal: controller.signal,
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.loc) {
                            const coords = data.loc.split(',');
                            if (coords.length === 2) {
                                return {
                                    lat: parseFloat(coords[0]),
                                    lng: parseFloat(coords[1]),
                                    accuracy: 3000,
                                    city: data.city,
                                    region: data.region,
                                    source: 'ipinfo.io'
                                };
                            }
                        }
                        throw new Error('Datos inv√°lidos');
                    },
                    // Servicio 4: geojs.io (respaldo final)
                    async () => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch('https://get.geojs.io/v1/ip/geo.json', {
                            signal: controller.signal,
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.latitude && data.longitude) {
                            return {
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                accuracy: 3000,
                                city: data.city,
                                region: data.region,
                                source: 'geojs.io'
                            };
                        }
                        throw new Error('Datos inv√°lidos');
                    }
                ];

                // Intentar cada servicio en orden
                for (let i = 0; i < servicios.length; i++) {
                    try {
                        const resultado = await servicios[i]();
                        
                        if (resultado && 
                            typeof resultado.lat === 'number' && 
                            typeof resultado.lng === 'number' &&
                            !isNaN(resultado.lat) && 
                            !isNaN(resultado.lng)) {
                            
                            console.log('‚úÖ Ubicaci√≥n obtenida por IP desde:', resultado.source, '- Ciudad:', resultado.city);
                            return {
                                lat: resultado.lat,
                                lng: resultado.lng,
                                accuracy: resultado.accuracy || 2000,
                                city: resultado.city,
                                region: resultado.region,
                                source: 'ip'
                            };
                        }
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Servicio ${i + 1} fall√≥:`, error.message);
                        // Continuar con el siguiente servicio
                        continue;
                    }
                }

                console.error('‚ùå Todos los servicios de geolocalizaci√≥n por IP fallaron');
                return null;
            }

            // Funci√≥n para mostrar la ubicaci√≥n en el mapa
            function mostrarUbicacionEnMapa(userLocation, accuracy, source = 'gps') {
                // Eliminar marcador anterior si existe
                if (userMarker) {
                    userMarker.setMap(null);
                }
                if (accuracyCircle) {
                    accuracyCircle.setMap(null);
                }

                // Crear marcador para la ubicaci√≥n del usuario
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: "Tu ubicaci√≥n actual",
                    icon: iconoUbicacionUsuario,
                    animation: google.maps.Animation.DROP
                });

                // Crear c√≠rculo de precisi√≥n
                accuracyCircle = new google.maps.Circle({
                    center: userLocation,
                    radius: accuracy,
                    map: map,
                    fillColor: '#4285F4',
                    fillOpacity: 0.15,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.3,
                    strokeWeight: 1
                });

                // Info window para la ubicaci√≥n del usuario
                let sourceText = '';
                if (source === 'ip') {
                    sourceText = ' (aproximada por IP)';
                } else if (source === 'google-geolocation') {
                    sourceText = ' (Google Geolocation API)';
                }
                
                const userInfoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="info-window">
                            <h3 style="color: #4285F4; margin-bottom: 10px;">üë§ Tu ubicaci√≥n${sourceText}</h3>
                            <p style="color: #666; font-size: 13px;">Est√°s aqu√≠</p>
                            <p style="color: #666; font-size: 12px; margin-top: 8px;">
                                Precisi√≥n: ${Math.round(accuracy)} metros
                            </p>
                        </div>
                    `
                });

                userMarker.addListener('click', () => {
                    userInfoWindow.open(map, userMarker);
                });

                // No mover el mapa - solo mostrar el marcador de ubicaci√≥n
            }

            // Funci√≥n para obtener y mostrar la ubicaci√≥n del usuario (siguiendo el patr√≥n del ejemplo)
            async function obtenerUbicacionUsuario(mostrarMensajeFlag = true) {
                // Prioridad 1: Geolocalizaci√≥n del navegador (GPS/Wi-Fi, m√°s precisa)
                if (navigator.geolocation) {
                    if (mostrarMensajeFlag) {
                        mostrarMensaje('Solicitando tu ubicaci√≥n...', 'info');
                    }

                    console.log('üåê Intentando geolocalizaci√≥n del navegador...');
                    
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            try {
                                const { latitude, longitude } = position.coords;
                                console.log('üìç Coordenadas obtenidas:', latitude, longitude);
                                
                                const userLocation = {
                                    lat: latitude,
                                    lng: longitude
                                };

                                mostrarUbicacionEnMapa(userLocation, position.coords.accuracy, 'gps');
                                
                                if (mostrarMensajeFlag) {
                                    mostrarMensaje('¬°Ubicaci√≥n encontrada!', 'success');
                                }
                            } catch (err) {
                                console.error('‚ùå Error procesando geolocalizaci√≥n:', err);
                                // Fallback a IP
                                await intentarUbicacionPorIP(mostrarMensajeFlag);
                            }
                        },
                        async function(error) {
                            // Si el usuario rechaza o no est√° disponible, intentar por IP
                            console.log('‚ö†Ô∏è Geolocalizaci√≥n del navegador fall√≥, intentando por IP...');
                            
                            // Si el permiso est√° denegado, mostrar instrucciones
                            if (error.code === error.PERMISSION_DENIED) {
                                const instructionsDiv = document.getElementById('geolocationInstructions');
                                if (instructionsDiv && mostrarMensajeFlag) {
                                    instructionsDiv.style.display = 'block';
                                    // Ocultar despu√©s de 15 segundos
                                    setTimeout(() => {
                                        instructionsDiv.style.display = 'none';
                                    }, 15000);
                                }
                            }
                            
                            await intentarUbicacionPorIP(mostrarMensajeFlag, error);
                        },
                        {
                            timeout: 8000,
                            enableHighAccuracy: true, // Usar GPS si est√° disponible
                            maximumAge: 300000 // Cache de 5 minutos
                        }
                    );
                } else {
                    // Si no hay soporte, ir directo a IP
                    console.log('‚ö†Ô∏è Navegador no soporta geolocalizaci√≥n, usando IP...');
                    await intentarUbicacionPorIP(mostrarMensajeFlag);
                }
            }

            // Funci√≥n helper para intentar ubicaci√≥n (Google Geolocation primero, luego IP)
            async function intentarUbicacionPorIP(mostrarMensajeFlag = true, error = null) {
                // Si el permiso est√° denegado y es autom√°tico, intentar silenciosamente
                if (error && error.code === error.PERMISSION_DENIED && !mostrarMensajeFlag) {
                    // Intentar Google Geolocation API primero (m√°s precisa)
                    const googleLocation = await obtenerUbicacionGoogleGeolocation();
                    if (googleLocation) {
                        mostrarUbicacionEnMapa(
                            { lat: googleLocation.lat, lng: googleLocation.lng },
                            googleLocation.accuracy,
                            'google-geolocation'
                        );
                        return;
                    }
                    
                    // Si falla, intentar IP
                    const ipLocation = await obtenerUbicacionPorIP();
                    if (ipLocation) {
                        mostrarUbicacionEnMapa(
                            { lat: ipLocation.lat, lng: ipLocation.lng },
                            ipLocation.accuracy,
                            'ip'
                        );
                    }
                    return;
                }

                if (mostrarMensajeFlag) {
                    mostrarMensaje('Obteniendo ubicaci√≥n...', 'info');
                }

                // Intentar Google Geolocation API primero (m√°s precisa que IP)
                const googleLocation = await obtenerUbicacionGoogleGeolocation();
                
                if (googleLocation) {
                    mostrarUbicacionEnMapa(
                        { lat: googleLocation.lat, lng: googleLocation.lng },
                        googleLocation.accuracy,
                        'google-geolocation'
                    );
                    if (mostrarMensajeFlag) {
                        const precisionKm = (googleLocation.accuracy / 1000).toFixed(1);
                        if (googleLocation.accuracy > 5000) {
                            mostrarMensaje(`Ubicaci√≥n aproximada (${precisionKm}km). Permite permisos para ubicaci√≥n exacta.`, 'info');
                        } else {
                            mostrarMensaje(`Ubicaci√≥n encontrada (precisi√≥n: ${Math.round(googleLocation.accuracy)}m)`, 'success');
                        }
                    }
                    return;
                }

                // Si Google Geolocation falla, intentar IP como respaldo
                if (mostrarMensajeFlag) {
                    mostrarMensaje('Obteniendo ubicaci√≥n aproximada por IP...', 'info');
                }

                const ipLocation = await obtenerUbicacionPorIP();
                
                if (ipLocation) {
                    mostrarUbicacionEnMapa(
                        { lat: ipLocation.lat, lng: ipLocation.lng },
                        ipLocation.accuracy,
                        'ip'
                    );
                    if (mostrarMensajeFlag) {
                        mostrarMensaje('Ubicaci√≥n aproximada encontrada (por IP)', 'success');
                    }
                } else {
                    if (mostrarMensajeFlag) {
                        let mensajeError = 'No se pudo obtener tu ubicaci√≥n.';
                        if (error) {
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    mensajeError = 'Permiso denegado. Permite el acceso a ubicaci√≥n para mayor precisi√≥n.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    mensajeError = 'Ubicaci√≥n no disponible.';
                                    break;
                                case error.TIMEOUT:
                                    mensajeError = 'Tiempo de espera agotado.';
                                    break;
                            }
                        }
                        mostrarMensaje(mensajeError, 'error');
                    }
                }
            }

            // Bot√≥n para solicitar ubicaci√≥n manualmente
            document.getElementById('btnGeolocation').addEventListener('click', function() {
                // Ocultar instrucciones si est√°n visibles
                const instructionsDiv = document.getElementById('geolocationInstructions');
                if (instructionsDiv) {
                    instructionsDiv.style.display = 'none';
                }
                obtenerUbicacionUsuario(true);
            });

            // Intentar obtener la ubicaci√≥n autom√°ticamente al cargar
            obtenerUbicacionUsuario(false);
        }
    </script>

    <!-- Google Maps API -->
    <script 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFGebMe1CODtGrn8fXU9oAa7-I6DgaBhM&callback=initMap&language=es&loading=async"
        async defer>
    </script>
</body>
</html>
